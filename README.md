# Web Transcriber

Веб-приложение для записи и транскрибации встреч в реальном времени. Объединяет звук микрофона и системный звук (вкладки), обрабатывает его через FFmpeg и отправляет в Deepgram.

## Особенности

- **Захват двух источников звука**: микрофон пользователя и системный звук (вкладка/окно)
- **Реальная транскрибация**: потоковая передача аудио в Deepgram с минимальной задержкой
- **HTTPS поддержка**: безопасный контекст для доступа к микрофону и системному звуку
- **Чистый интерфейс**: интуитивное управление с динамическим отображением кнопок
- **Скачивание результатов**: сохранение транскрипта в текстовый файл

## Архитектура

```
┌─────────────┐    WebSocket    ┌─────────────┐    WebSocket    ┌─────────────┐
│   Браузер   │ ───────────────> │   FastAPI   │ ───────────────> │   Deepgram  │
│  (Frontend) │ <─────────────── │  (Backend)  │ <─────────────── │             │
└─────────────┘                  └─────────────┘                  └─────────────┘
       │                                │
       │ MediaRecorder                  │ FFmpeg (Opus → PCM)
       │ (WebM/Opus)                    │
       ▼                                ▼
```

- **Frontend**: Vanilla JS + MediaRecorder API. Смешивает потоки через AudioContext.
- **Backend**: FastAPI (Async). Принимает WebM/Opus стрим, декодирует FFmpeg'ом в PCM "на лету" (pipes) и стримит в Deepgram.
- **Nginx**: HTTPS прокси, обслуживание статики, WebSocket проксирование.

## Предварительные требования

1. Docker и Docker Compose
2. API ключ от [Deepgram](https://deepgram.com/)
3. mkcert (для локальных SSL сертификатов) - установится автоматически

## Быстрый старт (Docker)

### 1. Настройка окружения

```bash
cd backend
cp .env.example .env
# Отредактируйте .env и вставьте ваш DEEPGRAM_API_KEY
cd ..
```

### 2. Генерация SSL сертификатов (для HTTPS)

```bash
# Установка mkcert (если не установлен)
sudo apt install libnss3-tools  # или эквивалент для вашей ОС
curl -s https://api.github.com/repos/FiloSottile/mkcert/releases/latest | grep browser_download_url | grep linux-amd64 | cut -d '"' -f 4 | wget -qi -
chmod +x mkcert-v*-linux-amd64
sudo mv mkcert-v*-linux-amd64 /usr/local/bin/mkcert

# Генерация сертификатов
mkcert -install
mkcert localhost
mkdir -p certs
mv localhost.pem certs/localhost+2.pem
mv localhost-key.pem certs/localhost+2-key.pem
```

### 3. Запуск приложения

```bash
docker-compose up --build -d
```

### 4. Использование

1. Откройте браузер по адресу **<https://localhost>** (примите предупреждение о самоподписанном сертификате)
2. Выберите микрофон и источники звука (микрофон и/или системный звук)
3. Нажмите **"Начать запись"**
4. Разрешите доступ к микрофону
5. Во всплывающем окне выберите вкладку или окно для захвата системного звука (**ОБЯЗАТЕЛЬНО поставьте галочку "Share audio"**)
6. Говорите - текст будет появляться на экране в реальном времени
7. Нажмите **"Остановить"** для завершения записи
8. Скачайте полный транскрипт по появившейся ссылке

## Интерфейс

- **До начала записи**: видна только кнопка "Начать запись"
- **Во время записи**: видна только кнопка "Остановить"
- **После завершения**: появляется ссылка для скачивания и снова кнопка "Начать запись"

## Локальный запуск (без Docker)

### Backend

1. Установите FFmpeg в систему:

   ```bash
   sudo apt install ffmpeg  # Ubuntu/Debian
   # или brew install ffmpeg  # macOS
   ```

2. Python 3.10+:

   ```bash
   cd backend
   python -m venv venv
   source venv/bin/activate  # или venv\Scripts\activate на Windows
   pip install -r requirements.txt
   ```

3. Настройте переменные окружения:

   ```bash
   cp .env.example .env
   # Отредактируйте .env, добавьте DEEPGRAM_API_KEY
   ```

4. Запуск сервера:

   ```bash
   uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
   ```

### Frontend

1. Откройте `frontend/index.html` в браузере через HTTPS (можно использовать `python -m http.server 443 --ssl` с сертификатами)
2. Убедитесь, что в `app.js` адрес WebSocket соответствует локальному серверу (`wss://localhost/ws/stream` для HTTPS)

## Конфигурация

### Переменные окружения (backend/.env)

| Переменная | Описание | Значение по умолчанию |
|------------|----------|----------------------|
| `DEEPGRAM_API_KEY` | API ключ Deepgram | (обязательно) |
| `DEEPGRAM_CHUNK_SIZE` | Размер буфера отправки в Deepgram | 3200 |
| `QUEUE_MAX_SIZE` | Размер очереди asyncio | 40 |
| `CHUNK_DURATION_MS` | Длительность чанка в миллисекундах | 450 |

### Nginx конфигурация

- Порт 80: HTTP → HTTPS редирект
- Порт 443: HTTPS с самоподписанными сертификатами
- Проксирование `/ws/stream` → backend:8000
- Проксирование `/download/*` → backend:8000
- Обслуживание статики из `/usr/share/nginx/html`

## Отладка и мониторинг

### Просмотр логов

```bash
# Логи бэкенда
docker-compose logs -f backend

# Логи фронтенда (nginx)
docker-compose logs -f frontend
```

### Проверка состояния

```bash
docker-compose ps
```

### Остановка приложения

```bash
docker-compose down
```

## Профилирование

FFmpeg запускается как подпроцесс. Чтобы проверить нагрузку:

```bash
docker stats
```

Если нагрузка высокая, FFmpeg может не успевать декодировать Opus. Убедитесь, что клиент шлет данные с разумным интервалом (по умолчанию 450ms).

## Устранение проблем

### 1. "Нет доступа к микрофону"

- Убедитесь, что используете HTTPS
- Проверьте разрешения браузера
- Перезагрузите страницу

### 2. "Нет звука с системного источника"

- При выборе окна/вкладки обязательно поставьте галочку "Share audio"
- Убедитесь, что в выбранном окне есть звук

### 3. "WebSocket соединение разрывается"

- Проверьте, что бэкенд запущен (`docker-compose ps`)
- Проверьте логи бэкенда на наличие ошибок

### 4. "Нет транскрипции"

- Проверьте API ключ Deepgram в `.env` файле
- Убедитесь, что есть звук на входе (проверьте индикаторы громкости системы)

## Лицензия

MIT

## Авторы

Проект разработан для транскрибации рабочих встреч с минимальными усилиями пользователя.
